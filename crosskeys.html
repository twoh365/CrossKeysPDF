<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Crosskeys — Invoice</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root {
      --cream: #f5f0e9;
      --ink: #222;
      --line: #c8c3bb;
      --panel: #fffdfa
    }

    html,
    body {
      height: 100%;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif
    }

    body {
      background: var(--cream);
      color: var(--ink)
    }

    #invoice {
      width: 210mm;
      min-height: 297mm;
      background: var(--cream);
      padding: 18mm 16mm;
      border: 1px solid var(--line);
      box-sizing: border-box
    }

    #invoice::before {
      content: "CK";
      position: absolute;
      font-family: Georgia, "Times New Roman", serif;
      font-size: 140mm;
      opacity: .03
    }

    .logo {
      max-width: 40mm;
      height: auto
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    td,
    th {
      padding: 6px 8px
    }

    .right {
      text-align: right
    }
  </style>
</head>

<body>
  <main id="app" style="max-width:960px;margin:20px auto">
    <section style="margin-bottom:16px">
      <h1 style="margin:.2em 0">Crosskeys — Invoice Maker</h1>
      <div style="color:#666;font-size:.95em">PDF-only. Dates shown in DD/MM/YYYY.</div>
    </section>

    <section class="card" style="background:#fff;padding:12px;border:1px solid #e3e3e3;border-radius:8px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label>Guest name</label>
          <input id="guestName" type="text" style="width:100%;padding:8px;margin-top:6px">
        </div>
        <div>
          <label>Room type</label>
          <input id="roomType" type="text" style="width:100%;padding:8px;margin-top:6px"
            value="Double Room with Private Bathroom">
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
        <div>
          <label>Check-in</label>
          <input id="checkIn" type="date" style="width:100%;padding:8px;margin-top:6px">
        </div>
        <div>
          <label>Check-out</label>
          <input id="checkOut" type="date" style="width:100%;padding:8px;margin-top:6px">
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button onclick="previewInvoice()" style="padding:8px 12px">Preview</button>
        <button onclick="generateInvoice()" style="padding:8px 12px;background:#eee">Download PDF</button>
      </div>
    </section>

    <div id="invoice" style="display:none;margin-top:18px;position:relative">
      <header style="text-align:center;margin-bottom:12px">
        <div class="logo-container" style="margin-bottom:6px;text-align:center">
          <img id="logoImg" class="logo"
            src="https://raw.githubusercontent.com/twoh365/CrossKeysPDF/main/images/crosskeys-logo.png"
            alt="Crosskeys Logo" crossorigin="anonymous"
            onerror="this.style.display='none';document.getElementById('logoText').style.display='block'">
          <div id="logoText" style="display:none;font-family:Georgia,serif;font-size:18pt">CROSSKEYS</div>
        </div>
        <h2 style="margin:.2em 0;font-family:Georgia,serif">Crosskeys — Invoice</h2>
      </header>

      <section style="margin-bottom:8px">
        <div><strong>Guest:</strong> <span id="outGuest"></span></div>
        <div><strong>Room:</strong> <span id="outRoom"></span></div>
        <div><strong>Invoice date:</strong> <span id="outInvoiceDate"></span></div>
        <div><strong>Check-in:</strong> <span id="outCheckIn"></span></div>
        <div><strong>Check-out:</strong> <span id="outCheckOut"></span></div>
      </section>

      <section>
        <table>
          <thead>
            <tr>
              <th>Description</th>
              <th>Date</th>
              <th class="right">Amount</th>
            </tr>
          </thead>
          <tbody id="outRows"></tbody>
          <tfoot>
            <tr>
              <td colspan="2" class="right">Total</td>
              <td class="right" id="outTotal"></td>
            </tr>
          </tfoot>
        </table>
      </section>
    </div>
  </main>

  <script>
    // small helpers
    const fmtGBP = n => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(Number(n || 0));
    function formatDateUK(iso) { if (!iso) return ''; const [y, m, d] = iso.split('-'); return `${d}/${m}/${y}` }

    function listNights(startISO, endISO) { const out = []; if (!startISO || !endISO) return out; let d = new Date(startISO + 'T00:00:00'); const end = new Date(endISO + 'T00:00:00'); while (d < end) { const y = d.getFullYear(); const m = String(d.getMonth() + 1).padStart(2, '0'); const dd = String(d.getDate()).padStart(2, '0'); out.push(`${y}-${m}-${dd}`); d.setDate(d.getDate() + 1); } return out }

    function computeRows() { const checkIn = document.getElementById('checkIn').value; const checkOut = document.getElementById('checkOut').value; const nights = listNights(checkIn, checkOut); const rows = []; if (nights.length === 0) { rows.push({ desc: 'Accommodation', date: checkIn || '', amt: 0 }); } else { nights.forEach(d => rows.push({ desc: 'Accommodation', date: d, amt: 0 })); } return rows }

    function previewInvoice() { const guest = document.getElementById('guestName').value; const room = document.getElementById('roomType').value; const invDate = new Date(); const isoInv = `${invDate.getFullYear()}-${String(invDate.getMonth() + 1).padStart(2, '0')}-${String(invDate.getDate()).padStart(2, '0')}`; document.getElementById('outGuest').innerText = guest; document.getElementById('outRoom').innerText = room; document.getElementById('outInvoiceDate').innerText = formatDateUK(isoInv); const checkIn = document.getElementById('checkIn').value; const checkOut = document.getElementById('checkOut').value; document.getElementById('outCheckIn').innerText = formatDateUK(checkIn); document.getElementById('outCheckOut').innerText = formatDateUK(checkOut); const rows = computeRows(); const tbody = document.getElementById('outRows'); tbody.innerHTML = ''; let total = 0; rows.forEach(r => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${r.desc}</td><td>${formatDateUK(r.date)}</td><td class="right">${fmtGBP(r.amt)}</td>`; tbody.appendChild(tr); total += r.amt; }); document.getElementById('outTotal').innerText = fmtGBP(total); document.getElementById('invoice').style.display = 'block'; }

    /* Wait for images to load (promise) */
    function waitForImages(root, timeoutMs = 3000) {
      const imgs = Array.from((root || document).querySelectorAll('img'));
      if (!imgs.length) return Promise.resolve();
      return new Promise(resolve => {
        let remaining = imgs.length;
        const done = () => { if (--remaining <= 0) resolve(); };
        imgs.forEach(img => {
          if (img.complete && img.naturalWidth !== 0) return done();
          const onEnd = () => { img.removeEventListener('load', onEnd); img.removeEventListener('error', onEnd); done(); };
          img.addEventListener('load', onEnd);
          img.addEventListener('error', onEnd);
        });
        setTimeout(resolve, timeoutMs);
      });
    }

    async function generateInvoice() {
      previewInvoice(); const el = document.getElementById('invoice'); el.style.display = 'block'; await waitForImages(el, 3000); const opt = { margin: [8, 8, 8, 8], image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, logging: false }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: ['css', 'legacy'] } }; const filename = 'Crosskeys-Invoice.pdf'; try { await html2pdf().from(el).set(opt).toPdf().get('pdf').then(pdf => pdf.save(filename)); } catch (e) { try { const blob = await html2pdf().from(el).set(opt).outputPdf('blob'); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(() => URL.revokeObjectURL(url), 500); } catch (err) { console.error('PDF generation failed', err); alert('Failed to generate PDF. Try Preview then Download.'); } }
    }
    // sensible defaults on load
    (function () { const t = new Date(); const iso = `${t.getFullYear()}-${String(t.getMonth() + 1).padStart(2, '0')}-${String(t.getDate()).padStart(2, '0')}`; if (!document.getElementById('checkIn').value) document.getElementById('checkIn').value = iso; if (!document.getElementById('checkOut').value) document.getElementById('checkOut').value = iso; })();
  </script>
</body>

</html>