<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crosskeys -- Invoice Maker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --cream: #f5f0e9;
            --ink: #222;
            --line: #c8c3bb;
            --ink-muted: #555;
            --panel: #fffdfa;
            --watermark: #1a1a1a;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: var(--cream);
            color: var(--ink);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans", "Liberation Sans", sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #app {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px
        }

        .card {
            background: #fff;
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 16px;
            margin: 0 0 16px 0;
        }

        .controls label {
            display: block;
            margin: 8px 0 4px;
            font-weight: 600
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--line);
            border-radius: 8px;
            background: #fff;
            font: inherit;
        }

        .btn {
            padding: 10px 14px;
            border: 1px solid var(--line);
            background: #fff;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700
        }

        .btn.primary {
            background: var(--cream)
        }

        .btn.danger {
            background: #fff3f3
        }

        .muted {
            color: var(--ink-muted);
            font-size: .9em
        }

        /* A4 canvas */
        #invoice {
            width: 210mm;
            height: 297mm;
            background: var(--cream);
            color: var(--ink);
            margin: 0 auto;
            padding: 16mm 14mm;
            border: 1px solid var(--line);
            position: relative;
            overflow: hidden;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            page-break-after: avoid;
        }

        #invoice::before {
            content: "CK";
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: Georgia, "Times New Roman", serif;
            font-size: 140mm;
            font-weight: 800;
            letter-spacing: .02em;
            color: var(--watermark);
            opacity: .03;
            transform: translateY(10mm);
            pointer-events: none;
            user-select: none;
        }

        .header {
            text-align: center;
            position: relative;
            z-index: 1
        }

        .logo-container {
            text-align: center;
            margin: 0 auto;
            background-color: #f5f0e9 !important;
            padding: 12px;
            border-radius: 8px;
            display: inline-block;
        }

        .logo {
            max-width: 50mm;
            height: auto;
            display: block;
            background: transparent;
            mix-blend-mode: multiply;
        }

        h2 {
            font-family: Georgia, "Times New Roman", serif;
            font-size: 18pt;
            font-weight: 700;
            margin: 8mm 0 4mm 0;
            position: relative;
            z-index: 1;
        }

        .divider {
            border-top: 2px solid var(--line);
            border-bottom: 1px solid var(--line);
            height: 0;
            margin: 6mm 0;
            position: relative;
            z-index: 1;
        }

        .brandline .prop {
            text-transform: uppercase;
            letter-spacing: .06em;
            font-size: 11px;
            color: #444;
            font-weight: 700;
        }

        .details-box {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 8px;
            padding: 8px 10px;
            margin-top: 4mm;
            position: relative;
            z-index: 1;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px
        }

        .right {
            text-align: right
        }

        .prop {
            text-transform: uppercase;
            letter-spacing: .05em;
            font-size: 10px;
            color: #555;
            font-weight: 800;
        }

        .val {
            font-weight: 600;
            font-size: 13px;
        }

        table {
            width: 100%
        }

        td,
        th {
            padding: 4px 6px;
            vertical-align: top
        }

        .amount {
            font-variant-numeric: tabular-nums;
        }

        table.charges {
            border-collapse: collapse;
            width: 100%;
            position: relative;
            z-index: 1;
            margin-top: 6mm;
        }

        table.charges th {
            text-align: left;
            text-transform: uppercase;
            font-size: 9px;
            letter-spacing: .04em;
            border-bottom: 1px solid var(--line);
            padding-bottom: 4px;
            font-weight: 700;
        }

        table.charges td.right {
            text-align: right
        }

        table.charges tbody tr:nth-child(even) {
            background: #fdfcf9;
        }

        table.charges tbody tr td {
            padding-top: 5px;
            padding-bottom: 5px;
            font-size: 12px;
        }

        tfoot tr:first-child td,
        tfoot tr:first-child th {
            border-top: 2px solid var(--line);
            padding-top: 6px;
        }

        tfoot tr td {
            padding-top: 4px;
            padding-bottom: 4px;
            font-size: 11px;
        }

        .total {
            font-size: 13px;
            letter-spacing: .015em;
            font-weight: 700;
        }

        .note {
            font-style: italic;
            color: var(--ink-muted);
            margin-top: 4px;
            font-size: 10px;
        }

        .footer {
            border-top: 1px solid var(--line);
            margin-top: 6mm;
            padding-top: 3mm;
            text-align: center;
            font-size: 9px;
            color: var(--ink-muted);
            position: relative;
            z-index: 1;
            line-height: 1.4;
        }

        .small {
            font-size: 11px
        }

        @media screen {
            table.charges tbody tr:hover td {
                background: rgba(0, 0, 0, .03);
            }
        }

        @media print {
            .no-print {
                display: none !important
            }

            body {
                background: var(--cream)
            }

            #invoice {
                border: none
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="card controls no-print">
            <h1 style="margin:0 0 6px 0;">Crosskeys -- Invoice Maker</h1>
            <div class="muted">Flat rate (rate or total) or custom nightly rates. VAT modes. Payment method. Full A4 cream export.</div>

            <div class="row" style="margin-top:12px;">
                <div>
                    <label>Guest Name</label>
                    <input type="text" id="guestName" placeholder="Guest full name" />
                </div>
                <div></div>
            </div>

            <div class="row">
                <div>
                    <label>Room Type</label>
                    <select id="roomType">
                        <option>Double Room with Private Bathroom</option>
                        <option>2-Double Beds Room with Private Bathroom</option>
                        <option>Family Room with Private Bathroom</option>
                        <option>Single Room with Private Bathroom</option>
                    </select>
                </div>
                <div></div>
            </div>

            <div class="row">
                <div>
                    <label>Check-In Date</label>
                    <input type="date" id="checkIn" />
                </div>
                <div>
                    <label>Check-Out Date</label>
                    <input type="date" id="checkOut" />
                </div>
            </div>

            <div class="row">
                <div>
                    <label>Rate Mode</label>
                    <select id="rateMode">
                        <option value="flat">Flat Rate</option>
                        <option value="custom">Custom Nightly Rates</option>
                    </select>
                </div>
                <div>
                    <label>VAT Option</label>
                    <select id="vatOption">
                        <option value="off">VAT Off</option>
                        <option value="excluded">VAT Excluded (add 20%)</option>
                        <option value="included" selected>VAT Included (in rate)</option>
                    </select>
                </div>
            </div>

            <!-- Flat rate block -->
            <div id="flatRateBlock" class="row">
                <div>
                    <label>Flat Rate Input</label>
                    <select id="flatInputMode">
                        <option value="rate">Rate per Night</option>
                        <option value="total">Total for Stay</option>
                    </select>
                </div>
                <div>
                    <label id="flatLabel">Rate per Night (£)</label>
                    <input type="number" id="rateOrTotal" step="0.01" placeholder="0.00" />
                </div>
            </div>

            <!-- Custom rates block -->
            <div id="customRateBlock" style="display:none;">
                <label>Nightly Charges (one row per night)</label>
                <table class="builder" id="nightsTable" style="width:100%;border-collapse:collapse;margin-top:8px">
                    <thead>
                        <tr>
                            <th style="text-align:left">Date</th>
                            <th style="text-align:left">Rate (£)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="nightsTbody"></tbody>
                </table>
                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn" type="button" onclick="addNightRow()">Add Night</button>
                    <button class="btn" type="button" onclick="populateNightsFromRange()">Populate nights from date range</button>
                    <button class="btn danger" type="button" onclick="clearNights()">Clear nights</button>
                </div>
                <div class="muted" style="margin-top:6px;">
                    Tip: If Flat Rate is set to <em>Rate per Night</em>, populated rows use that rate.
                    If it's <em>Total for Stay</em>, the total is evenly split across the number of nights.
                </div>
            </div>

            <div class="row" style="margin-top:12px;">
                <div>
                    <label>Invoice Date</label>
                    <input type="date" id="invoiceDate" />
                </div>
                <div>
                    <label>Payment Method</label>
                    <select id="paymentMethod">
                        <option>Bank Transfer</option>
                        <option>Cheque</option>
                        <option>Cash</option>
                        <option>Card</option>
                        <option selected>Paid by Card Via Booking.com.</option>
                    </select>
                </div>
            </div>

            <div class="row" style="margin-top:12px;">
                <div>
                    <label>Payment Notes (optional)</label>
                    <textarea id="paymentNotes" rows="2" placeholder="e.g. Paid in cash on arrival"></textarea>
                </div>
                <div>
                    <label>Notes Style</label>
                    <select id="notesStyle">
                        <option value="normal">Normal</option>
                        <option value="italic" selected>Italic</option>
                    </select>
                </div>
            </div>

            <label style="margin-top:8px;">Footer Text</label>
            <textarea id="footerText" rows="3">Thank you for choosing Crosskeys.
For enquiries, please contact us via your reservation on Booking.com.</textarea>

            <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn primary" type="button" onclick="generateInvoice()">Download PDF</button>
                <button class="btn" type="button" onclick="previewInvoice()">Preview on Page</button>
            </div>
        </div>

        <!-- PDF -->
        <div id="invoice" role="document" aria-label="Invoice preview" style="display:none;">
            <div class="header">
                <div class="logo-container">
                    <img id="logoImg"
                        src="https://raw.githubusercontent.com/twoh365/CrossKeysPDF/main/images/crosskeys-logo.png"
                        alt="Crosskeys Logo" class="logo" crossorigin="anonymous"
                        onerror="this.style.display='none';document.getElementById('logoText').style.display='block'">
                    <div id="logoText"
                        style="display:none;font-family:Georgia,serif;font-weight:800;letter-spacing:.06em">CROSSKEYS
                    </div>
                </div>
                <div class="brandline" style="margin-top:6px;">
                    <div class="prop">43 Lanark Road, Edinburgh EH14 1TL, Scotland</div>
                </div>
            </div>

            <h2 style="text-align: center;">Invoice for Your Stay at Crosskeys</h2>
            <div class="divider"></div>

            <div class="details-box">
                <div class="two-col small">
                    <div>
                        <div class="prop">Guest Name:</div>
                        <div id="outGuest" class="val"></div>
                        <div class="prop" style="margin-top:4px;">Room Type:</div>
                        <div id="outRoom"></div>
                    </div>
                    <div class="right">
                        <div><span class="prop">Invoice Date:</span> <span id="outInvoiceDate"></span></div>
                        <div><span class="prop">Check-In:</span> <span id="outCheckIn"></span></div>
                        <div><span class="prop">Check-Out:</span> <span id="outCheckOut"></span></div>
                        <div><span class="prop">Nights:</span> <span id="outNights"></span></div>
                    </div>
                </div>
            </div>

            <!-- Flat (always nightly lines) -->
            <div id="flatChargesBlock">
                <table class="charges">
                    <thead>
                        <tr>
                            <th>Description:</th>
                            <th>Date:</th>
                            <th class="right">Cost:</th>
                        </tr>
                    </thead>
                    <tbody id="outFlatNightRows"></tbody>
                    <tfoot>
                        <tr id="vatRow" style="display:none;">
                            <td colspan="2" class="right">VAT (20%)</td>
                            <td class="right amount"><span id="outVAT"></span></td>
                        </tr>
                        <tr>
                            <td colspan="2" class="right" style="font-weight:700;">Total Due</td>
                            <td class="right" style="font-weight:700;font-size:13px;"><span id="outTotal"></span></td>
                        </tr>
                    </tfoot>
                </table>
                <div id="vatNote" class="note" style="display:none;">VAT of 20% is included in the rate.</div>
            </div>

            <!-- Custom nightly -->
            <div id="customChargesBlock" style="display:none;">
                <table class="charges">
                    <thead>
                        <tr>
                            <th>Description:</th>
                            <th>Date:</th>
                            <th class="right">Cost:</th>
                        </tr>
                    </thead>
                    <tbody id="outNightRows"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2" class="right" style="font-weight:700;">Subtotal</td>
                            <td class="right" style="font-weight:700;"><span id="outSubtotalCustom"></span></td>
                        </tr>
                        <tr id="vatRowCustom" style="display:none;">
                            <td colspan="2" class="right">VAT (20%)</td>
                            <td class="right amount"><span id="outVATCustom"></span></td>
                        </tr>
                        <tr>
                            <td colspan="2" class="right" style="font-weight:700;">Total Due</td>
                            <td class="right" style="font-weight:700;font-size:13px;"><span id="outTotalCustom"></span></td>
                        </tr>
                    </tfoot>
                </table>
                <div id="vatNoteCustom" class="note" style="display:none;">VAT of 20% is included in the rate.</div>
            </div>

            <div style="margin-top:8mm;" class="small">
                <span class="prop">Payment Method:</span>
                <span id="outPaymentMethod"></span>
            </div>

            <div style="margin-top:2mm;" class="small" id="outPaymentNotesWrapper" hidden>
                <span class="prop">Notes:</span>
                <span id="outPaymentNotes"></span>
            </div>

            <div class="footer" id="outFooter"></div>

            <div class="small" style="margin-top:8mm; text-align:center; color: #666;">
                We Step Limited<br>41 Larnark Road, EH14 1TL<br>VAT No. 458030991
            </div>
        </div>
    </div>

    <script>
        /* Currency (GBP) */
        const gbp = new Intl.NumberFormat('en-GB', {
            style: 'currency', currency: 'GBP', minimumFractionDigits: 2, maximumFractionDigits: 2
        });
        const fmtGBP = n => gbp.format((+n) || 0);

        /* Date helpers */
        function ordinal(n) {
            const s = ["th", "st", "nd", "rd"], v = n % 100;
            return s[(v - 20) % 10] || s[v] || s[0];
        }

        function formatDatePretty(iso) {
            if (!iso) return "";
            const [year, month, day] = iso.split('-').map(Number);
            const d = new Date(year, month - 1, day);
            return `${d.getDate()}${ordinal(d.getDate())} of ${d.toLocaleString('en-GB', { month: 'long', year: 'numeric' })}`;
        }

        function formatDateUK(iso) {
            if (!iso) return "";
            const [year, month, day] = iso.split('-').map(Number);
            const d = new Date(year, month - 1, day);
            return d.toLocaleDateString('en-GB');
        }

        function listNights(startISO, endISO) {
            if (!startISO || !endISO) return [];
            const [sy, sm, sd] = startISO.split('-').map(Number);
            const [ey, em, ed] = endISO.split('-').map(Number);
            const start = new Date(sy, sm - 1, sd);
            const end = new Date(ey, em - 1, ed);
            const nights = [];
            let current = new Date(start);
            while (current < end) {
                const y = current.getFullYear();
                const m = String(current.getMonth() + 1).padStart(2, '0');
                const d = String(current.getDate()).padStart(2, '0');
                nights.push(`${y}-${m}-${d}`);
                current.setDate(current.getDate() + 1);
            }
            return nights;
        }

        function splitEvenly(total, count) {
            if (count <= 0) return [];
            const perNight = Math.floor(total * 100 / count) / 100;
            const remainder = Math.round((total * 100) - (perNight * 100 * count)) / 100;
            const amounts = Array(count).fill(perNight);
            if (remainder !== 0) amounts[amounts.length - 1] += remainder;
            return amounts;
        }

        function waitForImages(root, timeoutMs = 3000) {
            return new Promise(resolve => {
                const imgs = root.querySelectorAll('img');
                let loaded = 0, errors = 0;
                const total = imgs.length;
                if (total === 0) { resolve(); return; }
                const onComplete = () => { if (loaded + errors >= total) resolve(); };
                const timer = setTimeout(resolve, timeoutMs);
                imgs.forEach(img => {
                    const onLoad = () => { loaded++; onComplete(); clearTimeout(timer); };
                    const onError = () => { errors++; onComplete(); clearTimeout(timer); };
                    if (img.complete) { loaded++; } else {
                        img.addEventListener('load', onLoad, { once: true });
                        img.addEventListener('error', onError, { once: true });
                    }
                });
                onComplete();
            });
        }

        /* Initialize date inputs */
        const today = new Date();
        const todayISO = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
        document.getElementById('checkIn').value = todayISO;
        document.getElementById('checkOut').value = todayISO;
        document.getElementById('invoiceDate').value = todayISO;

        /* Rate mode toggle */
        document.getElementById('rateMode').addEventListener('change', e => {
            const isFlat = e.target.value === 'flat';
            document.getElementById('flatRateBlock').style.display = isFlat ? 'grid' : 'none';
            document.getElementById('customRateBlock').style.display = isFlat ? 'none' : 'block';
        });

        /* Flat input mode toggle label */
        document.getElementById('flatInputMode').addEventListener('change', e => {
            const label = document.getElementById('flatLabel');
            label.textContent = e.target.value === 'rate' ? 'Rate per Night (£)' : 'Total for Stay (£)';
        });

        /* Night row builder */
        function addNightRow(date = '', rate = '') {
            const tbody = document.getElementById('nightsTbody');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="date" class="night-date" value="${date}" style="width:100%;padding:4px;border:1px solid #ccc;border-radius:4px;" /></td>
                <td><input type="number" class="night-rate" value="${rate}" step="0.01" placeholder="0.00" style="width:100%;padding:4px;border:1px solid #ccc;border-radius:4px;" /></td>
                <td><button class="btn" type="button" onclick="this.parentElement.parentElement.remove()" style="padding:4px 8px;font-size:0.9em;">Delete</button></td>
            `;
            tbody.appendChild(tr);
        }

        function populateNightsFromRange() {
            const start = document.getElementById('checkIn').value;
            const end = document.getElementById('checkOut').value;
            if (!start || !end) { alert('Set check-in and check-out dates'); return; }
            const nights = listNights(start, end);
            const tbody = document.getElementById('nightsTbody');
            tbody.innerHTML = '';
            const flatRate = document.getElementById('rateOrTotal').value;
            const isRatePerNight = document.getElementById('flatInputMode').value === 'rate';
            let amounts = [];
            if (flatRate && !isRatePerNight) {
                amounts = splitEvenly(+flatRate, nights.length);
            }
            nights.forEach((night, i) => {
                const rate = isRatePerNight ? (flatRate || '') : (amounts[i] || '');
                addNightRow(night, rate);
            });
        }

        function clearNights() {
            document.getElementById('nightsTbody').innerHTML = '';
        }

        /* Generate invoice */
        async function generateInvoice() {
            const guest = document.getElementById('guestName').value || 'Guest';
            const room = document.getElementById('roomType').value;
            const checkIn = document.getElementById('checkIn').value;
            const checkOut = document.getElementById('checkOut').value;
            const rateMode = document.getElementById('rateMode').value;
            const vatOption = document.getElementById('vatOption').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentNotes = document.getElementById('paymentNotes').value;
            const notesStyle = document.getElementById('notesStyle').value;
            const footerText = document.getElementById('footerText').value;

            if (!checkIn || !checkOut) { alert('Set check-in and check-out dates'); return; }

            const nights = listNights(checkIn, checkOut);
            if (nights.length === 0) { alert('Check-out must be after check-in'); return; }

            /* Populate invoice */
            document.getElementById('outGuest').textContent = guest;
            document.getElementById('outRoom').textContent = room;
            document.getElementById('outInvoiceDate').textContent = formatDateUK(invoiceDate);
            document.getElementById('outCheckIn').textContent = formatDateUK(checkIn);
            document.getElementById('outCheckOut').textContent = formatDateUK(checkOut);
            document.getElementById('outNights').textContent = nights.length;

            let amounts = [];
            if (rateMode === 'flat') {
                const val = +document.getElementById('rateOrTotal').value || 0;
                const isRate = document.getElementById('flatInputMode').value === 'rate';
                amounts = isRate ? Array(nights.length).fill(val) : splitEvenly(val, nights.length);

                document.getElementById('flatChargesBlock').style.display = 'block';
                document.getElementById('customChargesBlock').style.display = 'none';

                const flatRows = document.getElementById('outFlatNightRows');
                flatRows.innerHTML = '';
                let subtotal = 0;
                nights.forEach((night, i) => {
                    const amt = amounts[i] || 0;
                    subtotal += amt;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>Accommodation</td>
                        <td>${formatDateUK(night)}</td>
                        <td class="right amount">${fmtGBP(amt)}</td>
                    `;
                    flatRows.appendChild(tr);
                });

                let total = subtotal;
                document.getElementById('vatRow').style.display = 'none';
                document.getElementById('vatNote').style.display = 'none';

                if (vatOption === 'excluded') {
                    const vat = subtotal * 0.2;
                    total = subtotal + vat;
                    document.getElementById('outVAT').textContent = fmtGBP(vat);
                    document.getElementById('vatRow').style.display = 'table-row';
                    document.getElementById('vatNote').style.display = 'none';
                } else if (vatOption === 'included') {
                    document.getElementById('vatNote').style.display = 'block';
                }

                document.getElementById('outTotal').textContent = fmtGBP(total);
            } else {
                document.getElementById('flatChargesBlock').style.display = 'none';
                document.getElementById('customChargesBlock').style.display = 'block';

                const rows = document.getElementById('nightsTable').querySelectorAll('tbody tr');
                const customRows = document.getElementById('outNightRows');
                customRows.innerHTML = '';

                let subtotal = 0;
                rows.forEach(tr => {
                    const date = tr.querySelector('.night-date').value;
                    const rate = +(tr.querySelector('.night-rate').value || 0);
                    subtotal += rate;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>Accommodation</td>
                        <td>${date ? formatDateUK(date) : ''}</td>
                        <td class="right amount">${fmtGBP(rate)}</td>
                    `;
                    customRows.appendChild(row);
                });

                let total = subtotal;
                document.getElementById('outSubtotalCustom').textContent = fmtGBP(subtotal);
                document.getElementById('vatRowCustom').style.display = 'none';
                document.getElementById('vatNoteCustom').style.display = 'none';

                if (vatOption === 'excluded') {
                    const vat = subtotal * 0.2;
                    total = subtotal + vat;
                    document.getElementById('outVATCustom').textContent = fmtGBP(vat);
                    document.getElementById('vatRowCustom').style.display = 'table-row';
                } else if (vatOption === 'included') {
                    document.getElementById('vatNoteCustom').style.display = 'block';
                }

                document.getElementById('outTotalCustom').textContent = fmtGBP(total);
            }

            /* Payment & notes */
            document.getElementById('outPaymentMethod').textContent = paymentMethod;
            const notesWrapper = document.getElementById('outPaymentNotesWrapper');
            if (paymentNotes) {
                notesWrapper.hidden = false;
                document.getElementById('outPaymentNotes').textContent = paymentNotes;
                document.getElementById('outPaymentNotes').style.fontStyle = notesStyle === 'italic' ? 'italic' : 'normal';
            } else {
                notesWrapper.hidden = true;
            }

            /* Footer */
            document.getElementById('outFooter').textContent = footerText;
            document.getElementById('outFooter').style.fontStyle = notesStyle === 'italic' ? 'italic' : 'normal';

            /* Show invoice */
            document.getElementById('invoice').style.display = 'block';
            await waitForImages(document.getElementById('invoice'));

            const opt = {
                margin: 0,
                filename: 'Crosskeys-Invoice.pdf',
                image: { type: 'png', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, logging: false, scrollY: 0, allowTaint: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', compress: true },
                pagebreak: { mode: ['css', 'legacy'], avoid: 'tr' }
            };

            try {
                const pdf = html2pdf().set(opt).from(document.getElementById('invoice')).save();
            } catch (e) {
                console.error('PDF generation error:', e);
                const canvas = await html2canvas(document.getElementById('invoice'), { scale: 2, useCORS: true, logging: false });
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = 'Crosskeys-Invoice.pdf';
                link.click();
            }

            document.getElementById('invoice').style.display = 'none';
        }

        /* Preview invoice (without downloading) */
        async function previewInvoice() {
            const guest = document.getElementById('guestName').value || 'Guest';
            const room = document.getElementById('roomType').value;
            const checkIn = document.getElementById('checkIn').value;
            const checkOut = document.getElementById('checkOut').value;
            const rateMode = document.getElementById('rateMode').value;
            const vatOption = document.getElementById('vatOption').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentNotes = document.getElementById('paymentNotes').value;
            const notesStyle = document.getElementById('notesStyle').value;
            const footerText = document.getElementById('footerText').value;

            if (!checkIn || !checkOut) { alert('Set check-in and check-out dates'); return; }

            const nights = listNights(checkIn, checkOut);
            if (nights.length === 0) { alert('Check-out must be after check-in'); return; }

            document.getElementById('outGuest').textContent = guest;
            document.getElementById('outRoom').textContent = room;
            document.getElementById('outInvoiceDate').textContent = formatDateUK(invoiceDate);
            document.getElementById('outCheckIn').textContent = formatDateUK(checkIn);
            document.getElementById('outCheckOut').textContent = formatDateUK(checkOut);
            document.getElementById('outNights').textContent = nights.length;

            let amounts = [];
            if (rateMode === 'flat') {
                const val = +document.getElementById('rateOrTotal').value || 0;
                const isRate = document.getElementById('flatInputMode').value === 'rate';
                amounts = isRate ? Array(nights.length).fill(val) : splitEvenly(val, nights.length);

                document.getElementById('flatChargesBlock').style.display = 'block';
                document.getElementById('customChargesBlock').style.display = 'none';

                const flatRows = document.getElementById('outFlatNightRows');
                flatRows.innerHTML = '';
                let subtotal = 0;
                nights.forEach((night, i) => {
                    const amt = amounts[i] || 0;
                    subtotal += amt;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>Accommodation</td>
                        <td>${formatDateUK(night)}</td>
                        <td class="right amount">${fmtGBP(amt)}</td>
                    `;
                    flatRows.appendChild(tr);
                });

                let total = subtotal;
                document.getElementById('vatRow').style.display = 'none';
                document.getElementById('vatNote').style.display = 'none';

                if (vatOption === 'excluded') {
                    const vat = subtotal * 0.2;
                    total = subtotal + vat;
                    document.getElementById('outVAT').textContent = fmtGBP(vat);
                    document.getElementById('vatRow').style.display = 'table-row';
                } else if (vatOption === 'included') {
                    document.getElementById('vatNote').style.display = 'block';
                }

                document.getElementById('outTotal').textContent = fmtGBP(total);
            } else {
                document.getElementById('flatChargesBlock').style.display = 'none';
                document.getElementById('customChargesBlock').style.display = 'block';

                const rows = document.getElementById('nightsTable').querySelectorAll('tbody tr');
                const customRows = document.getElementById('outNightRows');
                customRows.innerHTML = '';

                let subtotal = 0;
                rows.forEach(tr => {
                    const date = tr.querySelector('.night-date').value;
                    const rate = +(tr.querySelector('.night-rate').value || 0);
                    subtotal += rate;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>Accommodation</td>
                        <td>${date ? formatDateUK(date) : ''}</td>
                        <td class="right amount">${fmtGBP(rate)}</td>
                    `;
                    customRows.appendChild(row);
                });

                let total = subtotal;
                document.getElementById('outSubtotalCustom').textContent = fmtGBP(subtotal);
                document.getElementById('vatRowCustom').style.display = 'none';
                document.getElementById('vatNoteCustom').style.display = 'none';

                if (vatOption === 'excluded') {
                    const vat = subtotal * 0.2;
                    total = subtotal + vat;
                    document.getElementById('outVATCustom').textContent = fmtGBP(vat);
                    document.getElementById('vatRowCustom').style.display = 'table-row';
                } else if (vatOption === 'included') {
                    document.getElementById('vatNoteCustom').style.display = 'block';
                }

                document.getElementById('outTotalCustom').textContent = fmtGBP(total);
            }

            document.getElementById('outPaymentMethod').textContent = paymentMethod;
            const notesWrapper = document.getElementById('outPaymentNotesWrapper');
            if (paymentNotes) {
                notesWrapper.hidden = false;
                document.getElementById('outPaymentNotes').textContent = paymentNotes;
                document.getElementById('outPaymentNotes').style.fontStyle = notesStyle === 'italic' ? 'italic' : 'normal';
            } else {
                notesWrapper.hidden = true;
            }

            document.getElementById('outFooter').textContent = footerText;
            document.getElementById('outFooter').style.fontStyle = notesStyle === 'italic' ? 'italic' : 'normal';

            document.getElementById('invoice').style.display = 'block';
            document.getElementById('invoice').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
</body>
</html>
